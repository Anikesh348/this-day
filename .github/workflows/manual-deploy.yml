name: Manual Deploy ThisDay (Docker Build + Up)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Git branch to deploy"
        required: true
        default: "feat/thisDay"
      environment:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Join Tailscale tailnet
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          hostname: gha-deploy-thisday

      - name: ğŸ” Verify Tailscale connectivity
        run: |
          echo "== Tailscale status =="
          tailscale status
          echo ""
          echo "== Tailscale IPs =="
          tailscale ip
          echo ""
          echo "== Ping Pi over tailnet =="
          ping -c 3 ${{ secrets.PI_HOST }}

      - name: ğŸš€ Deploy on Raspberry Pi
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USER }}
          key: ${{ secrets.PI_SSH_KEY }}
          script: |
            set -euxo pipefail

            DEPLOY_BRANCH="${{ github.event.inputs.branch }}"
            APP_ENV="${{ github.event.inputs.environment }}"

            echo "====================================="
            echo "ğŸ“ Connected to Raspberry Pi"
            echo "Branch      : ${DEPLOY_BRANCH}"
            echo "Environment : ${APP_ENV}"
            echo "====================================="

            echo "ğŸ“‚ Switching to project directory"
            cd /srv/this-day

            echo "ğŸ“Œ Git status (before)"
            git status
            git branch --show-current

            echo "â¬‡ï¸ Fetching latest changes"
            git fetch origin

            echo "ğŸ“Œ Checking out ${DEPLOY_BRANCH}"
            git checkout "${DEPLOY_BRANCH}"

            echo "â¬‡ï¸ Pulling latest commits"
            git pull origin "${DEPLOY_BRANCH}"

            echo "ğŸ“Œ Latest commit"
            git log -1 --oneline

            echo "====================================="
            echo "ğŸ³ Docker Compose status (before)"
            docker compose ps
            echo "====================================="

            echo "ğŸ”¨ Building Docker images"
            APP_ENV="${APP_ENV}" docker compose --profile "${APP_ENV}" build

            echo "ğŸš€ Starting containers"
            APP_ENV="${APP_ENV}" docker compose --profile "${APP_ENV}" up -d

            echo "====================================="
            echo "ğŸ³ Docker Compose status (after)"
            docker compose ps
            echo "====================================="

            echo "ğŸ“œ Recent container logs (last 100 lines)"
            docker compose logs --tail=100
